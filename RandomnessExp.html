<!DOCTYPE html>
<html>
  <head>
    <script src="jspsych-6.3.1/jspsych.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-html-form.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-multi-choice.js"></script>

    <link rel="stylesheet" href="jspsych-6.3.1/css/jspsych.css">
  </head>
  <body>
    <script>
      /* experiment parameters */
      var FIXATION_DURATION = 500;
      var string_num = 1;
      var NUM_TRIALS = string_num * 4;

      /* create a subject ID */
      var subjectID =
        "SUBJ_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

      /* Create demographic questions */
      var demographicQuestions = {
        type: "survey-html-form",
        preamble: `
            <p>Please provide the following information:</p>
            <p>Your responses are confidential and will be used solely for research purposes. You may choose to skip any questions you do not wish to answer.</p>
        `,
        html: `
            <div>
                <label for="gender">Gender Identity:</label>
                <select name="gender" id="gender">
                    <option value="" disabled selected>Select your option</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="nonbinary">Non-binary</option>
                    <option value="other">Other</option>
                    <option value="prefer-not-to-say">Prefer not to say</option>
                </select>
            </div>
            <div>
                <label for="age">Age:</label>
                <input type="number" name="age" id="age" placeholder="Enter your age" min="18" max="120">
            </div>
            <div>
                <label for="race">Race/Ethnicity (select all that apply):</label>
                <div>
                    <input type="checkbox" name="race" value="american-indian-alaska-native"> Native American or Alaska Native<br>
                    <input type="checkbox" name="race" value="asian"> Asian<br>
                    <input type="checkbox" name="race" value="black-african-american"> Black or African American<br>
                    <input type="checkbox" name="race" value="hispanic-latino"> Hispanic or Latino<br>
                    <input type="checkbox" name="race" value="native-hawaiian-pacific-islander"> Native Hawaiian or Pacific Islander<br>
                    <input type="checkbox" name="race" value="white"> White<br>
                    <input type="checkbox" name="race" value="middle-eastern-north-african"> Middle Eastern or North African<br>
                    <input type="checkbox" name="race" value="other"> Other<br>
                    <input type="checkbox" name="race" value="prefer-not-to-say"> Prefer not to say<br>
                </div>
            </div>
            <div>
                <label for="education">Highest Level of Education Completed:</label>
                <select name="education" id="education">
                    <option value="" disabled selected>Select your option</option>
                    <option value="less-than-high-school">Less than High School</option>
                    <option value="high-school-diploma">High School Diploma or GED</option>
                    <option value="some-college-no-degree">Some College, No Degree</option>
                    <option value="associate-degree">Associate Degree</option>
                    <option value="bachelor-degree">Bachelor's Degree</option>
                    <option value="master-degree">Master's Degree</option>
                    <option value="professional-degree">Professional Degree (e.g., MD, JD)</option>
                    <option value="doctorate-degree">Doctorate Degree (e.g., PhD)</option>
                    <option value="other">Other</option>
                    <option value="prefer-not-to-say">Prefer not to say</option>
                </select>
            </div>
            <div>
                <label for="stats-course">Have you ever taken any statistics course?</label>
                <select name="stats-course" id="stats-course">
                    <option value="" disabled selected>Select your option</option>
                    <option value="yes-formal">Yes, formal course</option>
                    <option value="yes-informal">Yes, informal learning</option>
                    <option value="no">No</option>
                    <option value="other">Other</option>
                    <option value="prefer-not-to-say">Prefer not to say</option>
                </select>
            </div>
        `,
        on_finish: function (data) {
          // Process and store the responses
          var formData = jsPsych.data.get().last(1).values()[0].response;

          // Prepare demographics data
          demographicsData = {
            "subj ID": subjectID,
            Gender: formData.gender || "Not provided",
            Age: formData.age || "Not provided",
            Race: [], // We'll process this next
            Education: formData.education || "Not provided",
            StatCourse: formData["stats-course"] || "Not provided",
          };

          // Collect race data
          var raceSelections = [];
          var raceInputs = document.querySelectorAll(
            'input[name="race"]:checked'
          );
          raceInputs.forEach(function (input) {
            raceSelections.push(input.value);
          });
          demographicsData.Race = raceSelections.join(", ") || "Not provided";

          // Add the demographics data to all subsequent trials
          jsPsych.data.addProperties(demographicsData);
        },
      };

      /* Split cover story into smaller screens */
      var coverStoryTexts = [
        `Imagine you are a space rescuer whose job is to search for astronauts lost in deep space. Our fleet of spaceships are all equipped with radio transmitters, which can be operated by the astronaut in case they are in need of rescue.`,
        `To call for help, astronauts can use the transmitter to send out sequences made of two types of radio waves - 0 and 1. However, both types of waves may also be produced by natural phenomena, such as celestial body activities - in this case, 0 and 1 are equally likely to appear.`,
        `Everyone in space knows that by current technical standard, radio receivers can only pick up 10 waves in a row - that is, you can only detect sequences that have 10 waves (as mentioned before, each wave is either 0 or 1).`,
        `If you receive a sequence and think it was produced by natural phenomena, you will ignore it and stay on course. If you think it came from humans, then we will send a rescue team.`,
        `In this study, you will see about 250 sequences. Your task is to decide whether each sequence was generated by a natural phenomenon or by a human astronaut. Please answer as quickly and accurately as possible!`,
      ];

      var coverStoryScreens = coverStoryTexts.map(function (text) {
        return {
          type: "html-keyboard-response",
          stimulus: "<p>" + text + "</p><p>Press any key to continue.</p>",
        };
      });

      /* create instructions */
      var instructions = {
        type: "html-keyboard-response",
        stimulus: `<p>In the following experiment, you will be shown strings and asked to rate their randomness.</p>
              <p>Rate the randomness of each string on a scale from 1 (nonrandom) to 5 (very random).</p>
              <p>Press any key to begin.</p>`,
      };

      /* create the task components */
      var fixation = {
        type: "html-keyboard-response",
        stimulus:
          '<p style="font-size: 48px; font-family: monospace;">+</p>',
        choices: jsPsych.NO_KEYS,
        trial_duration: FIXATION_DURATION,
      };

      /* Randomly select trials without repetition */
      function getRandomTrials(array, numTrials) {
        var shuffledArray = array.slice().sort(function () {
          return 0.5 - Math.random();
        });
        return shuffledArray.slice(0, numTrials);
      }

      // Add cover story to main timeline
      var mainTimeline = [];
      mainTimeline.push(demographicQuestions);
      coverStoryScreens.forEach(function (trial) {
        mainTimeline.push(trial);
      });

      // Add instructions to main timeline
      mainTimeline.push(instructions);

      // Updated condition descriptions without numbers and fixed typos
      var conditionDescriptions = [
        // Index 0: Desire Present
        "In the quadrant you are currently monitoring, the astronauts are trained to be vigilant and to always accept help. When the emergency protocol is triggered, they will follow guidelines and send distress signals, as they very much want help to arrive.",

        // Index 1: Desire Absent
        "In the quadrant you are currently monitoring, the astronauts are trained to be unafraid and are reluctant to accept help when the emergency protocol is triggered. They will follow guidelines and send distress signals but do not really want help to arrive.",

        // Index 2: Belief Present
        "In the quadrant you are currently monitoring, astronauts have a detailed, up-to-date instruction manual for what to do in case of an emergency. As a result, the astronauts know that the signals should be non-random sequences since only then do the rescue ships recognize the sequences as a distress signal.",

        // Index 3: Belief Absent
        "In the quadrant you are currently monitoring, astronauts have an instruction manual for what to do in case of an emergency but it has some unfortunate omissions. As a result, the astronauts don't know that the signals should be non-random sequences, since only then do the rescue ships recognize the sequences as a distress signal.",

        // Index 4: Skill Present
        "In the quadrant you are currently monitoring, each member of the team is well-trained to use the transmission equipment. Even though the equipment can be difficult to operate when in zero gravity and while wearing bulky gloves, the astronauts are highly skilled at executing the radio transmissions they want to send.",

        // Index 5: Skill Absent
        "In the quadrant you are currently monitoring, no member of the team has been trained to use the transmission equipment. The equipment can be difficult to operate when in zero gravity and wearing bulky gloves, so the astronauts are often unable to execute the radio transmissions they want to send.",

        // Index 6: Awareness Present
        "In the quadrant you are currently monitoring, one of the reasons why a distress signal may be triggered is because of a life support malfunction. To stay fully conscious astronauts are equipped with oxygen tanks. As a result, when they are sending a radio transmission, they are fully aware of what they are doing.",

        // Index 7: Awareness Absent
        "In the quadrant you are currently monitoring, one of the reasons why a distress signal may be triggered is because of a life support malfunction. In such a state, astronauts will often drift in and out of consciousness. As a result, when they are sending a radio transmission, they may not be fully aware of what they are doing.",
      ];

      var comprehensionQuestions = [
        // Index 0: Desire Present
        [
          {
            prompt:
              "True or False: In this quadrant, astronauts desire to receive help and actively want help to arrive when they send a distress signal.",
            correct: "True",
          },
          {
            prompt:
              "True or False: You would expect astronauts in this quadrant to disregard guidelines when they encounter an emergency.",
            correct: "False",
          },
        ],

        // Index 1: Desire Absent
        [
          {
            prompt:
              "True or False: Astronauts in this quadrant are eager to accept help and express a strong desire for assistance when an emergency protocol is triggered.",
            correct: "False",
          },
          {
            prompt:
              "True or False: Astronauts in this quadrant have been trained to be independent and refuse help if offered.",
            correct: "True",
          },
        ],

        // Index 2: Belief Present
        [
          {
            prompt:
              "True or False: Astronauts in this quadrant believe that sending non-random sequences as distress signals will ensure their messages are recognized by rescue ships.",
            correct: "True",
          },
          {
            prompt:
              "True or False: The instruction manuals for astronauts in this quadrant are potentially out of date.",
            correct: "False",
          },
        ],

        // Index 3: Belief Absent
        [
          {
            prompt:
              "True or False: Astronauts have a clear understanding and believe that sending any type of signal, including random sequences, will be recognized by rescue ships as a distress signal.",
            correct: "False",
          },
          {
            prompt:
              "True or False: Astronauts in this quadrant have manuals which contain omissions that may impact their transmissions in the event of an emergency.",
            correct: "True",
          },
        ],

        // Index 4: Skill Present
        [
          {
            prompt:
              "True or False: All team members in this quadrant are well-trained and highly skilled at executing the radio transmissions they intend to send, despite the operation difficulties in zero gravity and while wearing bulky gloves.",
            correct: "True",
          },
          {
            prompt:
              "True or False: During a life support malfunction, astronauts will have to take off their gloves to send a signal.",
            correct: "False",
          },
        ],

        // Index 5: Skill Absent
        [
          {
            prompt:
              "True or False: The team members in this quadrant are proficient in using the transmission equipment, ensuring they can effectively execute the radio transmissions they intend to send.",
            correct: "False",
          },
          {
            prompt:
              "True or False: The astronauts in this quadrant are wearing bulky gloves.",
            correct: "True",
          },
        ],

        // Index 6: Awareness Present
        [
          {
            prompt:
              "True or False: During a life support malfunction, astronauts remain fully aware of their actions when sending a radio transmission, thanks to being equipped with oxygen tanks.",
            correct: "True",
          },
          {
            prompt:
              "True or False: During a life support malfunction, astronauts may slip in and out of consciousness due to lack of oxygen and this will affect their transmissions.",
            correct: "False",
          },
        ],

        // Index 7: Awareness Absent
        [
          {
            prompt:
              "True or False: During a life support malfunction, astronauts maintain constant awareness and full consciousness, unaffected by their physical state while sending radio transmissions.",
            correct: "False",
          },
          {
            prompt:
              "True or False: The lack of oxygen in these environments may impact the transmissions you receive.",
            correct: "True",
          },
        ],
      ];

      // Generate versions
      var NUM_STORIES_PER_VERSION = 4;
      var versions = [];

      for (var i = 0; i < conditionDescriptions.length; i++) {
        for (var j = i + 1; j < conditionDescriptions.length; j++) {
          for (var k = j + 1; k < conditionDescriptions.length; k++) {
            for (var l = k + 1; l < conditionDescriptions.length; l++) {
              var version = [
                conditionDescriptions[i],
                conditionDescriptions[j],
                conditionDescriptions[k],
                conditionDescriptions[l],
              ];
              versions.push(version);
            }
          }
        }
      }

      // Shuffle versions
      function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var temp = array[i];
          array[i] = array[j];
          array[j] = temp;
        }
      }
      shuffleArray(versions);

      // Prepare versions to ensure each has a unique set of comprehension questions
      var preparedVersions = versions.map(function (version, idx) {
        // Extract comprehension questions for this version
        var comprehensionQuestionsForVersion = version.map(function (
          description
        ) {
          var index = conditionDescriptions.indexOf(description);
          return comprehensionQuestions[index];
        });
        return {
          version: idx + 1, // version number, if you need it
          descriptions: version,
          questions: comprehensionQuestionsForVersion,
        };
      });

      var selectedVersion =
        preparedVersions[Math.floor(Math.random() * preparedVersions.length)];

      selectedVersion.descriptions.forEach(function (
        description,
        versionIndex
      ) {
        let descriptionTrial = {
          type: "html-keyboard-response",
          stimulus:
            "<p>" + description + "</p><p>Press any key to continue.</p>",
        };

        // Correctly access the set of questions for the current description
        let questionSet = selectedVersion.questions[versionIndex];

        // Initialize the warning message as empty
        let warningMessage = "";

        let comprehensionLoop = {
          timeline: [
            {
              type: "survey-multi-choice",
              preamble: function () {
                return (
                  warningMessage +
                  '<button id="show-description">Read Story Again</button><div id="description" style="display:none;">' +
                  description +
                  "</div>"
                );
              },
              questions: questionSet.map(function (q, index) {
                return {
                  prompt: q.prompt,
                  options: ["True", "False"],
                  required: true,
                  horizontal: true,
                  name: "Q" + index, // Unique name for each question
                };
              }),
              on_load: function () {
                document
                  .getElementById("show-description")
                  .addEventListener("click", function () {
                    var desc = document.getElementById("description");
                    if (desc.style.display === "none") {
                      desc.style.display = "block";
                    } else {
                      desc.style.display = "none";
                    }
                  });
              },
              on_finish: function (data) {
                var responses = data.response;
                var allCorrect = true; // Assume true initially

                questionSet.forEach(function (question, index) {
                  var responseKey = "Q" + index;
                  var correctAnswer = question.correct;
                  var userAnswer = responses[responseKey];

                  if (userAnswer !== correctAnswer) {
                    allCorrect = false; // Set to false if any answer is incorrect
                  }
                });

                data.allCorrect = allCorrect;
              },
            },
          ],
          loop_function: function (data) {
            if (!data.values()[0].allCorrect) {
              // Participant got at least one answer wrong

              // Update the warning message
              warningMessage =
                '<p style="color:red;">Some of your answers were not correct. Please try again.</p>';

              return true; // Repeat the loop
            } else {
              // Reset the warning message
              warningMessage = "";

              return false; // All answers were correct; do not repeat the loop
            }
          },
        };

        mainTimeline.push(descriptionTrial, comprehensionLoop);

        // Now add 'string_num' string trials after each description and question
        for (let i = 0; i < string_num; i++) {
          // This calculation is to ensure we're pulling the correct strings
          let trialIndex = versionIndex * string_num + i;

          // Placeholder for string stimuli (you should replace this with your actual stimuli)
          let stringTrial = "1010101010"; // Example string

          let trial = {
            type: "survey-likert",
            questions: [
              {
                prompt:
                  "<p>Please rate how random you think this string is:</p><p>" +
                  stringTrial +
                  "</p>",
                labels: [
                  "1 (not random)",
                  "2",
                  "3",
                  "4",
                  "5 (very random)",
                ],
                required: true,
              },
            ],
            data: {
              "subj ID": subjectID,
              stimulus: stringTrial,
              task: "rating",
            },
          };

          mainTimeline.push(trial);
        }

        // Optionally, add a fixation between sets if desired
        let fixation = {
          type: "html-keyboard-response",
          stimulus: '<div style="font-size:24px;">+</div>',
          choices: jsPsych.NO_KEYS,
          trial_duration: 1000, // Adjust as necessary
        };

        mainTimeline.push(fixation);
      });

      /* Create the end screen */
      var end = {
        type: "html-keyboard-response",
        stimulus: `<p>You're done! A .csv file containing your data should be automatically downloading right now.
            Check your default downloads location to find it. Once you've found it, you can close the experiment.</p>`,
        on_load: function () {
          jsPsych.data
            .get()
            .localSave("csv", "psychology_test_data_" + subjectID + ".csv");
        },
      };

      /* add end screen to main timeline */
      mainTimeline.push(end);

      /* run the experiment */
      jsPsych.init({
        timeline: mainTimeline,
        experiment_width: 850,
      });
    </script>
  </body>
</html>
