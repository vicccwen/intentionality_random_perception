<!DOCTYPE html>
<html>
<head>
  <script src="jspsych-6.3.1/jspsych.js"></script>
  <script src="jspsych-6.3.1/plugins/jspsych-survey-likert.js"></script>
  <script src="jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
  <link rel="stylesheet" href="jspsych-6.3.1/css/jspsych.css">
</head>
<body>
  <script>
    /* experiment parameters */
    var FIXATION_DURATION = 500;
    var NUM_TRIALS = 160;
    var string_num = 1;
    var NUM_TRIALS = string_num * 8;

    /* create cover story */
    var coverStory = {
      type: 'html-keyboard-response',
      stimulus: `<p>Imagine you are a space rescuer whose job is to search for astronauts lost in deep space. Our fleet of spaceships are all equipped with radio transmitters, which can be operated by the astronaut in case they are in need of rescue. To call for help, astronauts can use the transmitter to send out sequences made of two types of radio waves— Lambda (Λ) and Gamma (Γ). However, both types of waves may also be produced by natural phenomena, such as celestial body activities—in this case, Λ and Γ are equally likely to appear. Everyone in space knows that by current technical standard, radio receivers can only pick up [10] waves in a row— that is, you can only detect sequences that have [10] waves (as mentioned before, each wave is either Λ or Γ). If you receive a sequence and think it was produced by natural phenomena, you will ignore it and stay on course. If you think it came from humans, then we will send a rescue team. In this study, you will see about 250 sequences. Your task is to decide whether each sequence was generated by a natural phenomenon or by a human astronaut. Please answer as quickly and accurately as possible!</p>
      <p>Press any key to continue.</p>`
    };

    /* create instructions */
    var instructions = {
      type: 'html-keyboard-response',
      stimulus: `<p>In the following experiment, you will be shown strings and asked to rate their randomness.</p>
        <p>Rate the randomness of each string on a scale from 1 (nonrandom) to 5 (very random).</p>
        <p>Press any key to begin.</p>`
    };

    /* create the task components */
    var fixation = {
      type: 'html-keyboard-response',
      stimulus: '<p style="font-size: 48px; font-family: monospace;">+</p>',
      choices: jsPsych.NO_KEYS,
      trial_duration: FIXATION_DURATION
    };

    var numpool = [{"00000000":"00000001"},{"00000000":"00000010"}, /* ... (remaining data) ... */ {"00000000":"11111110"},{"00000000":"11111111"}];

    /* Randomly select trials without repetition */
    function getRandomTrials(array, numTrials) {
      var shuffledArray = array.slice().sort(function () {
        return 0.5 - Math.random();
      });
      return shuffledArray.slice(0, numTrials);
    }

    // Add cover story to main timeline
    var mainTimeline = [];
    mainTimeline.push(coverStory);

    /* create stories (vignettes) */
    var conditionDescriptions = [
      "In the quadrant you are currently monitoring, the astronauts are trained to be vigilant and to always accept help. When the emergency protocol is triggered, they will follow guidelines and send distress signals, as they very much want help to arrive.",
      "In the quadrant you are currently monitoring, the astronauts are trained to be unafraid and are reluctant to accept help when the emergency protocol is triggered. They will follow guidelines and send distress signals but do not really want help to arrive.",
      "In the quadrant you are currently monitoring, astronauts have a detailed, up-to-date instruction manual for what to do in case of an emergency. As a result, the astronauts know that the signals should be non-random sequences since only then do the rescue ships recognize the sequences as a distress signal.",
      "In the quadrant you are currently monitoring, astronauts have an instruction manual for what to do in case of an emergency but it has some unfortunate omissions. As a result, the astronauts don’t know that the signals should be non-random sequences, since only then do the rescue ships recognize the sequences as a distress signal.",
      "In the quadrant you are currently monitoring, each member of the team is well-trained to use the transmission equipment. Even though the equipment can be difficult to operate when in zero gravity and while wearing bulky gloves, the astronauts are highly skilled at executing the radio transmissions they want to send.",
      "In the quadrant you are currently monitoring, no member of the team has been trained to use the transmission equipment. The equipment can be difficult to operate when in zero gravity and wearing bulky gloves, so the astronauts are often unable to execute the radio transmissions they want to send.",
      "In the quadrant you are currently monitoring, one of the reasons why a distress signal may be triggered is because of a life support malfunction. To stay fully conscious astronauts are equipped with oxygen tanks.  As a result, when they are sending a radio transmission, they are fully aware of what they are doing.",
      "In the quadrant you are currently monitoring, one of the reasons why a distress signal may be triggered is because of a life support malfunction.  In such as state, astronauts will often drift in and out of consciousness.  As a result, when they are sending a radio transmission, they may not be fully aware of what they are doing."
    ];

    // Function to create a timeline for a specific combination of stories
    function createTimeline(combination) {
      var timeline = [];

      // Add instructions to main timeline
      timeline.push(instructions);

      // Create a loop to iterate over the randomized trials
      for (var i = 0; i < randomizedTrials.length; i++) {
        // Add condition description every 1 trials, one string per story
        if (i % string_num === 0) {
          var conditionIndex = Math.floor(i / string_num) % conditionDescriptions.length;
          var conditionDescription = {
            type: 'html-keyboard-response',
            stimulus: '<p>' + conditionDescriptions[combination[conditionIndex]] + '</p>' +
                      '<p>Press any key to continue.</p>'
          };
          timeline.push(conditionDescription);
        }

        // Extract the string from the object
        var string = Object.values(randomizedTrials[i])[0];

        // Create a trial object
        var trial = {
          type: 'survey-likert',
          questions: [{
            prompt: string,
            labels: ['1', '2', '3', '4', '5']
          }],
          data: {
            stimulus: string,
            task: 'rating'
          }
        };

        // Add the trial object to the timeline
        timeline.push(fixation, trial);
      }

      return timeline;
    }

    // Generate randomized trials
    var randomizedTrials = getRandomTrials(numpool, NUM_TRIALS);

    // Create all possible combinations of 4 stories
    var allCombinations = [];
    for (var i = 0; i < conditionDescriptions.length; i++) {
      for (var j = i + 1; j < conditionDescriptions.length; j++) {
        for (var k = j + 1; k < conditionDescriptions.length; k++) {
          for (var l = k + 1; l < conditionDescriptions.length; l++) {
            allCombinations.push([i, j, k, l]);
          }
        }
      }
    }

    // Create timelines for all combinations of stories
    var allTimelines = [];
    for (var i = 0; i < allCombinations.length; i++) {
      allTimelines.push(createTimeline(allCombinations[i]));
    }

    // Create versions by selecting a subset of the timelines
    var versions = [];
    for (var i = 0; i < allCombinations.length; i++) {
      for (var j = i + 1; j < allCombinations.length; j++) {
        for (var k = j + 1; k < allCombinations.length; k++) {
          for (var l = k + 1; l < allCombinations.length; l++) {
            var version = allTimelines[i].concat(allTimelines[j], allTimelines[k], allTimelines[l]);
            versions.push(version);
          }
        }
      }
    }

    /* create the end screen */
    var end = {
      type: 'html-keyboard-response',
      stimulus: `<p>You're done! A .csv file containing your data should be automatically downloading right now.
        Check your default downloads location to find it. Once you've found it, you can close the experiment.</p>`,
      on_load: function() {
        jsPsych.data.get().localSave('csv', 'psychology_test_data.csv');
      }
    };

    /* add end screen to main timeline */
    versions.push(end);

    /* run the experiment */
    jsPsych.init({
      timeline: versions,
      show_progress_bar: true
    });
  </script>
</body>
</html>
